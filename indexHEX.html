<html>

<body id="page" style="overflow:hidden; margin: 0;">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>

  <script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>

  <style>
    image,rect {
      -webkit-clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    }
  </style>

  <script type="text/javascript">
    let urlLocale = new URL(window.location.href)
    console.log(urlLocale.searchParams.get("c")) ///.get("c"));

    const hexRatio = 1.1547005
    let axisScale = {
      padding: parseFloat(urlLocale.searchParams.get("p")),
      gap: parseFloat(urlLocale.searchParams.get("g")),
      wide: (urlLocale.searchParams.get("wide"))
    }

var URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT8O3Mk62YHM5jY3WF_5Bfc_L-_lWkbDINATSzr3uvF8WehERLMSshRNw32GB-9e-lM72EB0HeiWsiM/pub?gid=412777815&single=true&output=csv"
var xURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWQ6Tu7bFvRZnXRAReUb_SyBjclucR5of-jG9KCx9gN-NNmQdIKvb24i1he5oFS182XV_hSRU-bsut/pub?gid=0&single=true&output=csv"

    d3.csv(
     ( axisScale.wide  ? URL :xURL )
    ).then((data) => {
      let config = {
        "width": window.innerWidth - (axisScale.padding ? axisScale.padding * 2 : 0),
        "height": window.innerHeight - (axisScale.padding ? axisScale.padding * 2 : 0),
        "padding": (axisScale.padding ? axisScale.padding : 0),
        "maxRadius": 0,
        "tableauXscaleLeft": d3.min(data, d => parseFloat(d.HexX)),
        "tableauXscaleRight": d3.max(data, d => parseFloat(d.HexX) + 1),
        "tableauYscaleTop": d3.max(data, d => parseFloat(d.HexY)),
        "tableauYscaleBottom": d3.min(data, d => parseFloat(d.HexY)),
        "tableauPadding": 1
      }
      let xSpan = (config.tableauXscaleRight - config.tableauXscaleLeft)
      let ySpan = (config.tableauYscaleTop - config.tableauYscaleBottom)
      let gap = (axisScale.gap ? axisScale.gap : 5)
      let renderWidth = config.width
      let radius = (renderWidth / (xSpan + 1)) - gap
      let yGap = radius * hexRatio
      let autoHeight, yTop, topPadding = 0,
        leftPadding = 0
      if ((ySpan * (yGap ) * 2) < config.height) {
        // bounded by width
        autoHeight = ySpan * (yGap + 1 ) * 1.8 +  (gap * ySpan)        //(gap*4*hexRatio)<works on second
        yTop = autoHeight - 2 * yGap
        topPadding = (config.height - autoHeight) / 2
      } else { // bounded by height
        autoHeight = config.height
        radius = (autoHeight / (2 * hexRatio * (ySpan))) -gap
        config.width = radius * (ySpan) * 4 + (xSpan * gap)
        yTop = autoHeight - 2 * hexRatio * radius
        leftPadding = (window.innerWidth - config.width) / 2 - config.padding
      }


      document.getElementById("page").style.margin =
        `${config.padding + topPadding}px 0 0 ${config.padding + leftPadding}`

      let body = d3.select("body");

      let svg = body.append("svg")
        .attr("width", config.width)
        .attr("height", autoHeight)

      let xScale = d3.scaleLinear()
        .domain([config.tableauXscaleLeft, config.tableauXscaleRight])
        .range([0, config.width - radius])
      let yScale = d3.scaleLinear()
        .domain([config.tableauYscaleBottom, config.tableauYscaleTop])
        .range([yTop, 0])


      let groups = d3.select('svg')
        .selectAll('image')
        .data(data)
        .enter()
        .append('g')

        groups.append("rect")    
        .attr("x", d => xScale(d.HexX ))        
        .attr("y", d => yScale(d.HexY ))         
        .attr("width",  radius * 2)    
        .attr("height", radius * 2 * hexRatio); 

        groups.append('image')
        .attr('xlink:href', d => d.img)
        .attr('x', d => xScale(d.HexX))
        .attr('y', d => yScale(d.HexY))
        .attr("width", radius * 2)
        .attr("height", radius * 2 * hexRatio)

  




    })
  </script>
</body>

</html>